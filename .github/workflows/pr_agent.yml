name: PR-Agent

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  issue_comment:
    types: [created]

jobs:
  pr_agent_job:
    # ボットのコメントには反応しない（無限ループ防止）
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write
    name: Run PR Agent
    steps:
      - name: PR Agent action
        id: pr_agent
        uses: Codium-ai/pr-agent-action@main
        env:
          # 1. 認証設定
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_AI_STUDIO.GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # 変数名をフルパスにするのが確実
          OPENAI_KEY: ${{ secrets.GEMINI_API_KEY }} # 内部ライブラリ対策でダミーとして入れておくと安定します

          # 2. モデル設定 (2026年最新の2.5-flashを指定)
          PR_AGENT.MODEL: "gemini/gemini-2.5-flash"
          PR_AGENT.CONFIG.LANGUAGE: "japanese" # 日本語で回答

          # 3. 設計提案を強化するカスタム指示 (ADD/シニアエンジニア視点)
          PR_REVIEWS.EXTRA_INSTRUCTIONS: |
            あなたは7年以上の経験を持つシニアフルスタックエンジニアです。
            単なるバグチェックだけでなく、以下の観点で「設計提案」を必ず含めてください：
            - Laravel/TypeScriptにおけるベストプラクティス（SOLID原則、クリーンアーキテクチャ等）
            - AI駆動開発(ADD)を意識した、拡張性の高いリファクタリング案
            - パフォーマンスやセキュリティの懸念点

          # 4. 動作の微調整
          PR_REVIEWS.INLINE_CODE_COMMENTS: true # コード内に直接コメント
          PR_REVIEWS.PERSISTENT_COMMENT: true # レビュー結果を1つのコメントにまとめる